name: Secrets & Redaction Enforcement

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  secrets-scan:
    name: Scan for Secrets and Sensitive Data
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Run secrets scanner
        run: |
          bash scripts/audit/scan-secrets.sh
      
      - name: Verify no plaintext API key files
        run: |
          bash scripts/audit/check-no-plaintext-keys.sh
      
      - name: Check for backup files
        run: |
          echo "Checking for backup files in source directories..."
          BACKUP_FILES=$(find . -type f \( -name "*.backup" -o -name "*.bak" -o -name "*_backup" -o -name "*_bak" \) \
            -not -path "*/node_modules/*" \
            -not -path "*/dist/*" \
            -not -path "*/build/*" \
            -not -path "*/bin/*" \
            -not -path "*/obj/*" \
            -not -path "*/.git/*" \
            -not -path "*/docs/*" \
            -not -path "*/examples/*" || true)
          
          if [ -n "$BACKUP_FILES" ]; then
            echo "ERROR: Found backup files that should not be committed:"
            echo "$BACKUP_FILES"
            exit 1
          fi
          
          echo "✓ No backup files found"
  
  diagnostics-redaction-test:
    name: Test Diagnostics Bundle Redaction
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      
      - name: Restore dependencies
        run: dotnet restore Aura.sln
      
      - name: Run diagnostics bundle tests
        run: |
          dotnet test Aura.Tests/Aura.Tests.csproj \
            --filter "FullyQualifiedName~DiagnosticBundleService" \
            --configuration Release \
            --logger "console;verbosity=detailed" \
            --no-restore
        continue-on-error: true
        id: bundle_tests
      
      - name: Report test results
        run: |
          if [ "${{ steps.bundle_tests.outcome }}" = "failure" ]; then
            echo "⚠ Diagnostics bundle tests not yet implemented or failed"
            echo "This is acceptable during initial implementation"
          else
            echo "✓ Diagnostics bundle redaction tests passed"
          fi
  
  ci-artifacts-check:
    name: Check CI Artifacts for Secrets
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check workflow files for hardcoded secrets
        run: |
          echo "Checking workflow files for hardcoded secrets..."
          
          # Check for patterns that look like secrets in workflow files
          WORKFLOW_VIOLATIONS=$(grep -r -E "(sk-[a-zA-Z0-9_-]{20,}|Bearer eyJ|AKIA[0-9A-Z]{16})" .github/workflows/ || true)
          
          if [ -n "$WORKFLOW_VIOLATIONS" ]; then
            echo "ERROR: Found potential secrets in workflow files:"
            echo "$WORKFLOW_VIOLATIONS"
            exit 1
          fi
          
          echo "✓ No hardcoded secrets found in workflows"
      
      - name: Check for secret exposure in scripts
        run: |
          echo "Checking scripts for secret exposure risks..."
          
          # Look for scripts that might log secrets
          LOGGING_ISSUES=$(grep -r -n "echo.*\$.*KEY" scripts/ | grep -v "echo.*REDACTED" || true)
          
          if [ -n "$LOGGING_ISSUES" ]; then
            echo "WARNING: Found scripts that may log sensitive variables:"
            echo "$LOGGING_ISSUES"
            echo ""
            echo "Ensure these scripts redact sensitive information before logging."
          fi
          
          echo "✓ Script security check completed"
  
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [secrets-scan, diagnostics-redaction-test, ci-artifacts-check]
    if: always()
    
    steps:
      - name: Generate security summary
        run: |
          echo "# Security Enforcement Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Status" >> $GITHUB_STEP_SUMMARY
          echo "- Secrets Scan: ${{ needs.secrets-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Diagnostics Redaction: ${{ needs.diagnostics-redaction-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- CI Artifacts Check: ${{ needs.ci-artifacts-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.secrets-scan.result }}" = "success" ]; then
            echo "✅ No secrets or sensitive data detected in repository" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Secrets or sensitive data found - see job details" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Fail if any security checks failed
        if: needs.secrets-scan.result != 'success'
        run: |
          echo "Security enforcement failed. Review the job logs for details."
          exit 1

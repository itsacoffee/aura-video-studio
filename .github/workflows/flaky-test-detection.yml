name: Flaky Test Detection

on:
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      iterations:
        description: 'Number of test iterations'
        required: false
        default: '10'

permissions:
  contents: read
  issues: write

env:
  DOTNET_VERSION: '8.0.x'
  NODE_VERSION: '20'

jobs:
  detect-flaky-tests:
    name: Detect Flaky Tests
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: Aura.Web/package-lock.json
      
      - name: Restore .NET dependencies
        run: dotnet restore Aura.sln
      
      - name: Build .NET projects
        run: dotnet build Aura.sln --configuration Release --no-restore
      
      - name: Install frontend dependencies
        working-directory: Aura.Web
        run: npm ci
      
      - name: Run flaky test detection
        run: |
          ITERATIONS=${{ github.event.inputs.iterations || '10' }}
          bash scripts/test/detect-flaky-tests.sh $ITERATIONS
        continue-on-error: true
        id: flaky-detection
      
      - name: Upload flaky test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: flaky-test-results
          path: flaky-test-results/
          retention-days: 30
      
      - name: Create issue if flaky tests detected
        if: steps.flaky-detection.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let summary = 'Flaky tests detected but summary not available';
            try {
              summary = fs.readFileSync('flaky-test-results/summary.txt', 'utf8');
            } catch (e) {
              console.log('Could not read summary file');
            }
            
            const body = `
            ## ⚠️ Flaky Tests Detected
            
            The automated flaky test detection workflow has identified intermittent test failures.
            
            \`\`\`
            ${summary}
            \`\`\`
            
            ### What are flaky tests?
            Flaky tests are tests that sometimes pass and sometimes fail without any code changes. They often indicate:
            - Race conditions
            - Timing dependencies
            - Resource cleanup issues
            - Non-deterministic behavior
            
            ### Action Required
            1. Review the test results artifact
            2. Identify which tests are failing intermittently
            3. Fix the root cause (add proper waits, fix race conditions, etc.)
            4. Re-run the flaky test detection to verify the fix
            
            ### Artifacts
            Check the workflow run for detailed results: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
            `;
            
            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'flaky-tests',
            });
            
            if (issues.data.length === 0) {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: '⚠️ Flaky Tests Detected',
                body: body,
                labels: ['flaky-tests', 'testing', 'bug'],
              });
            } else {
              // Comment on existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: body,
              });
            }

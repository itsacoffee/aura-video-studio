#!/usr/bin/env node

/**
 * Generate TypeScript types from OpenAPI swagger.json
 * 
 * Usage:
 *   node scripts/generate-api-types.js [swagger-url]
 * 
 * Examples:
 *   node scripts/generate-api-types.js http://localhost:5005/swagger/v1/swagger.json
 *   node scripts/generate-api-types.js (uses default URL)
 */

import { execSync } from 'child_process';
import { existsSync, mkdirSync, writeFileSync } from 'fs';
import { resolve, dirname } from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const projectRoot = resolve(__dirname, '..');

// Configuration
const DEFAULT_SWAGGER_URL = 'http://localhost:5005/swagger/v1/swagger.json';
const OUTPUT_DIR = resolve(projectRoot, 'src/api/generated');
const OUTPUT_FILE = resolve(OUTPUT_DIR, 'schema.ts');
const TEMP_SWAGGER_FILE = resolve(OUTPUT_DIR, 'swagger.json');

const swaggerUrl = process.argv[2] || DEFAULT_SWAGGER_URL;

console.log('üîß OpenAPI Type Generator');
console.log('========================\n');

// Ensure output directory exists
if (!existsSync(OUTPUT_DIR)) {
  console.log(`üìÅ Creating output directory: ${OUTPUT_DIR}`);
  mkdirSync(OUTPUT_DIR, { recursive: true });
}

// Step 1: Download swagger.json
console.log(`üì• Downloading OpenAPI spec from: ${swaggerUrl}`);
try {
  const curlCommand = `curl -s -f "${swaggerUrl}" -o "${TEMP_SWAGGER_FILE}"`;
  execSync(curlCommand, { stdio: 'inherit' });
  
  if (!existsSync(TEMP_SWAGGER_FILE)) {
    throw new Error('Failed to download swagger.json');
  }
  
  console.log('‚úÖ Swagger spec downloaded\n');
} catch (error) {
  console.error('‚ùå Failed to download swagger.json');
  console.error('   Make sure the API server is running at:', swaggerUrl);
  console.error('\n   Start the API with: dotnet run --project Aura.Api\n');
  process.exit(1);
}

// Step 2: Generate TypeScript types using openapi-typescript
console.log('üî® Generating TypeScript types...');
try {
  const generateCommand = `npx openapi-typescript "${TEMP_SWAGGER_FILE}" -o "${OUTPUT_FILE}"`;
  execSync(generateCommand, { stdio: 'inherit' });
  
  console.log('‚úÖ Types generated successfully\n');
} catch (error) {
  console.error('‚ùå Failed to generate types');
  console.error(error.message);
  process.exit(1);
}

// Step 3: Add header comment to generated file
console.log('üìù Adding header comment to generated types...');
try {
  const fs = await import('fs');
  const content = fs.readFileSync(OUTPUT_FILE, 'utf-8');
  const header = `/**
 * Generated TypeScript types from OpenAPI specification
 * 
 * DO NOT EDIT THIS FILE MANUALLY
 * 
 * This file is auto-generated from the Aura API OpenAPI spec.
 * To regenerate, run: npm run generate:api-types
 * 
 * Generated from: ${swaggerUrl}
 * Generated at: ${new Date().toISOString()}
 */

`;
  
  fs.writeFileSync(OUTPUT_FILE, header + content);
  console.log('‚úÖ Header added\n');
} catch (error) {
  console.warn('‚ö†Ô∏è  Could not add header comment');
}

// Step 4: Create index.ts barrel export
console.log('üì¶ Creating barrel export...');
const indexContent = `/**
 * Barrel export for generated API types
 */

export * from './schema';
`;

writeFileSync(resolve(OUTPUT_DIR, 'index.ts'), indexContent);
console.log('‚úÖ Barrel export created\n');

// Success message
console.log('üéâ Type generation complete!');
console.log('   Generated files:');
console.log('   - src/api/generated/schema.ts');
console.log('   - src/api/generated/index.ts');
console.log('\n   Import with: import type { paths } from "@/api/generated";\n');

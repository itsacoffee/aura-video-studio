#!/usr/bin/env sh
. "$(dirname -- "$0")/_"

echo ""
echo "üîç Running pre-commit checks..."
echo ""

# Change to Aura.Web directory for npm commands
cd Aura.Web || exit 1

# Step 1: Run lint-staged to lint and format only staged files
echo "üìù Linting and formatting staged files..."
npx lint-staged

if [ $? -ne 0 ]; then
  echo ""
  echo "‚ùå Commit rejected: Linting or formatting failed"
  echo ""
  echo "Please fix the linting errors above before committing."
  echo "To bypass this check, use: git commit --no-verify"
  echo ""
  exit 1
fi

# Step 2: Scan for placeholder markers
echo ""
echo "üîç Scanning for placeholder markers..."
cd .. || exit 1
node scripts/audit/find-placeholders.js

if [ $? -ne 0 ]; then
  echo ""
  echo "‚ùå Commit rejected: Placeholder markers found in code"
  echo ""
  echo "Please remove TODO/FIXME/HACK comments before committing."
  echo "To bypass this check, use: git commit --no-verify"
  echo ""
  exit 1
fi

# Step 3: Run TypeScript type check (enforced when ENFORCE_TYPE_CHECK=1)
# Set ENFORCE_TYPE_CHECK=1 once all type errors are resolved
if [ "$ENFORCE_TYPE_CHECK" = "1" ]; then
  echo ""
  echo "üîß Running TypeScript type check..."
  cd Aura.Web || exit 1
  npm run typecheck

  if [ $? -ne 0 ]; then
    echo ""
    echo "‚ùå Commit rejected: TypeScript type errors found"
    echo ""
    echo "Please fix the type errors above before committing."
    echo "To bypass this check, use: git commit --no-verify"
    echo ""
    exit 1
  fi
fi

# Step 4: Run lint check to ensure zero warnings (enforced when ENFORCE_ZERO_WARNINGS=1)
# Set ENFORCE_ZERO_WARNINGS=1 once all warnings are resolved
if [ "$ENFORCE_ZERO_WARNINGS" = "1" ]; then
  echo ""
  echo "üîç Running lint check for warnings..."
  cd Aura.Web || exit 1
  npm run lint

  if [ $? -ne 0 ]; then
    echo ""
    echo "‚ùå Commit rejected: ESLint warnings or errors found"
    echo ""
    echo "Please fix all warnings and errors before committing."
    echo "Run 'npm run lint:fix' to auto-fix some issues."
    echo "To bypass this check, use: git commit --no-verify"
    echo ""
    exit 1
  fi
fi

echo ""
if [ "$ENFORCE_TYPE_CHECK" = "1" ] || [ "$ENFORCE_ZERO_WARNINGS" = "1" ]; then
  echo "‚úÖ All pre-commit checks passed"
else
  echo "‚úÖ Pre-commit checks passed (type check and zero-warnings enforcement disabled)"
  echo "   To enable: export ENFORCE_TYPE_CHECK=1 ENFORCE_ZERO_WARNINGS=1"
fi
echo ""
exit 0
